# 开发规范指南

## 1. 项目概述

DdOaListDownload 是一套完整的钉钉 API 对接系统，采用 Go + Vue 3 开发，除了支持下载钉钉 OA 列表数据外，还包含权限管理、API 配置、API 测试等核心功能，为企业提供完整的钉钉 API 对接解决方案。

## 2. 开发环境

### 2.1 后端开发环境（Go）

- **操作系统**：Windows
- **Go 版本**：1.20+
- **钉钉 SDK 版本**：dingtalk-sdk-go v1.5.0+（官方推荐最新稳定版）
- **开发工具**：Visual Studio Code 或 GoLand
- **包管理工具**：Go Modules

### 2.2 前端开发环境（Vue 3）

- **操作系统**：Windows
- **Node.js 版本**：18+
- **钉钉 SDK 版本**：dingtalk-jsapi v3.0.0+（官方推荐最新稳定版）
- **npm/yarn/pnpm 版本**：最新稳定版
- **开发工具**：Visual Studio Code 或 WebStorm

### 2.3 官方文档参考

钉钉官方开发文档：[https://open.dingtalk.com/document/development/](https://open.dingtalk.com/document/development/)

所有 API 开发必须严格参照钉钉官方文档进行，确保与官方 API 保持一致，避免使用非官方或已弃用的 API。

## 3. 项目结构

```
DdOaListDownload/
├── README.md              # 项目说明文档
├── backend/               # 后端目录
│   ├── main.go           # 后端入口文件
│   ├── go.mod            # Go 模块文件
│   ├── go.sum            # Go 依赖校验文件
│   ├── config/           # 配置目录
│   │   └── config.go     # 配置管理
│   ├── controller/       # 控制器目录
│   │   ├── downloader.go # 下载控制器
│   │   ├── auth.go       # 认证控制器
│   │   ├── permission.go # 权限控制器
│   │   ├── api_config.go # API 配置控制器
│   │   ├── api_test.go   # API 测试控制器
│   │   └── system.go     # 系统管理控制器
│   ├── service/          # 服务层目录
│   │   ├── downloader.go # 下载服务
│   │   ├── auth.go       # 认证服务
│   │   ├── permission.go # 权限服务
│   │   ├── api_config.go # API 配置服务
│   │   ├── api_test.go   # API 测试服务
│   │   └── system.go     # 系统管理服务
│   ├── model/            # 数据模型目录
│   │   ├── data.go       # 数据模型
│   │   ├── user.go       # 用户模型
│   │   ├── role.go       # 角色模型
│   │   ├── menu.go       # 菜单模型
│   │   ├── api_config.go # API 配置模型
│   │   └── log.go        # 日志模型
│   ├── middleware/       # 中间件目录
│   │   ├── auth.go       # 认证中间件
│   │   ├── cors.go       # CORS 中间件
│   │   └── logger.go     # 日志中间件
│   ├── utils/            # 工具函数目录
│   │   ├── http_client.go # HTTP 客户端
│   │   ├── jwt.go        # JWT 工具
│   │   └── encrypt.go    # 加密工具
│   └── database/         # 数据库目录
│       ├── db.go         # 数据库连接
│       └── redis.go      # Redis 连接
├── frontend/              # 前端目录
│   ├── package.json      # 前端依赖
│   ├── vite.config.js    # Vite 配置
│   ├── index.html        # HTML 入口
│   ├── src/              # 前端源代码
│   │   ├── main.js       # 前端入口文件
│   │   ├── App.vue       # 根组件
│   │   ├── router/       # 路由配置
│   │   ├── store/        # 状态管理
│   │   ├── components/   # 组件目录
│   │   │   ├── common/   # 通用组件
│   │   │   └── business/ # 业务组件
│   │   ├── views/        # 页面目录
│   │   │   ├── auth/     # 认证页面
│   │   │   │   └── login.vue # 登录页面
│   │   │   ├── download/ # 下载页面
│   │   │   │   └── index.vue # 下载首页
│   │   │   ├── permission/ # 权限管理
│   │   │   │   ├── user.vue # 用户管理
│   │   │   │   ├── role.vue # 角色管理
│   │   │   │   └── menu.vue # 菜单管理
│   │   │   ├── api/      # API 管理
│   │   │   │   ├── config.vue # API 配置
│   │   │   │   └── test.vue # API 测试
│   │   │   └── system/   # 系统管理
│   │   │       ├── parameter.vue # 参数配置
│   │   │       ├── log.vue # 日志管理
│   │   │       └── backup.vue # 备份恢复
│   │   ├── api/          # API 调用
│   │   └── utils/        # 工具函数
│   └── public/           # 静态资源目录
└── docs/                 # 文档目录
    ├── development_guide.md  # 开发规范指南
    └── implementation_plan.md  # 实施方案
```

## 4. 代码规范

### 4.1 命名规范

#### Go 后端
- **文件命名**：使用小写字母和下划线组合，如 `downloader.go`
- **包命名**：使用小写字母，如 `config`、`service`
- **函数命名**：使用驼峰命名法，如 `DownloadList`
- **变量命名**：使用驼峰命名法，如 `appKey`
- **常量命名**：使用全大写字母和下划线组合，如 `LOG_FORMAT`

#### Vue 前端
- **文件命名**：组件使用 PascalCase，如 `Downloader.vue`；工具函数使用小写字母和下划线组合，如 `http_client.js`
- **组件命名**：使用 PascalCase，如 `Downloader`
- **函数命名**：使用驼峰命名法，如 `downloadList`
- **变量命名**：使用驼峰命名法，如 `appKey`
- **常量命名**：使用全大写字母和下划线组合，如 `API_BASE_URL`

### 4.2 注释规范

#### Go 后端
- **文件头部**：每个文件必须包含作者、邮箱、时间和功能说明
- **函数注释**：每个导出函数必须包含功能说明、参数、返回值和异常说明
- **代码注释**：复杂代码段必须添加注释，说明代码逻辑

#### Vue 前端
- **文件头部**：每个组件文件必须包含功能说明
- **组件注释**：每个组件必须包含 props、emits、data 等说明
- **函数注释**：复杂函数必须包含功能说明、参数、返回值
- **代码注释**：复杂逻辑必须添加注释

### 4.3 代码风格

#### Go 后端
- 缩进：使用 4 个空格
- 行长度：每行不超过 120 个字符
- 空行：函数之间、逻辑块之间使用空行分隔
- 导入顺序：标准库 → 第三方库 → 本地库
- 使用 `go fmt` 格式化代码

#### Vue 前端
- 缩进：使用 2 个空格
- 行长度：每行不超过 120 个字符
- 空行：组件之间、逻辑块之间使用空行分隔
- 导入顺序：Vue 核心 → 第三方库 → 本地组件 → 样式文件
- 使用 ESLint 和 Prettier 格式化代码

## 5. 依赖管理

### 5.1 Go 后端
- 所有依赖必须在 `go.mod` 文件中声明
- 依赖版本必须明确指定
- 新增依赖必须经过项目负责人批准
- 使用 `go mod tidy` 管理依赖

### 5.2 Vue 前端
- 所有依赖必须在 `package.json` 文件中声明
- 依赖版本必须明确指定
- 新增依赖必须经过项目负责人批准
- 使用 `npm install` 或 `yarn install` 或 `pnpm install` 安装依赖

## 6. 日志规范

### 6.1 Go 后端
- 使用 `logrus` 库进行日志记录
- 日志级别：
  - `DEBUG`：调试信息
  - `INFO`：普通信息
  - `WARNING`：警告信息
  - `ERROR`：错误信息
  - `FATAL`：严重错误信息
- 日志格式：包含时间、级别、文件、行号和消息
- 日志输出：同时输出到控制台和文件

### 6.2 Vue 前端
- 使用浏览器控制台进行日志记录
- 生产环境中关闭调试日志
- 敏感信息不得输出到控制台

## 7. 错误处理

### 7.1 Go 后端
- 函数返回错误时，使用 `error` 类型
- 错误信息必须包含足够的上下文信息
- 使用 `errors.New()` 或 `fmt.Errorf()` 创建错误
- 关键操作必须进行错误检查

### 7.2 Vue 前端
- 使用 `try-catch` 捕获异步操作错误
- API 请求错误必须进行统一处理
- 错误信息必须友好地展示给用户

## 8. 测试规范

### 8.1 Go 后端
- 每个模块必须编写单元测试
- 测试文件命名：`*_test.go`
- 测试覆盖率目标：≥ 80%
- 使用 `go test` 运行测试
- 测试数据必须使用真实数据或模拟数据

### 8.2 Vue 前端
- 组件必须编写单元测试
- 使用 Vitest 或 Jest 进行测试
- 测试覆盖率目标：≥ 70%
- 测试文件命名：`*.spec.js` 或 `*.test.js`

## 9. 提交规范

- 提交信息必须清晰、简洁，说明修改内容
- 提交信息格式：`[类型] 描述`
  - 类型：feat（新功能）、fix（修复 bug）、docs（文档）、style（代码风格）、refactor（重构）、test（测试）、chore（构建/依赖）
  - 描述：简洁明了的修改说明
- 每个提交只包含一个功能或修复

## 10. 版本管理

- 使用语义化版本号：`MAJOR.MINOR.PATCH`
  - MAJOR：不兼容的 API 变更
  - MINOR：向下兼容的新功能
  - PATCH：向下兼容的 bug 修复
- 版本号必须在项目根目录的 `VERSION` 文件中声明
- 发布新版本时，必须创建 Git 标签

## 11. 文档规范

- 所有文档必须使用 Markdown 格式
- 文档必须包含作者、邮箱和时间信息
- 文档必须结构清晰，内容完整
- 代码变更必须同步更新相关文档
- API 文档必须使用 Swagger 或类似工具生成

## 12. 安全规范

- 敏感信息（如 AppKey、AppSecret）必须通过环境变量或配置文件管理，不得硬编码
- 网络请求必须使用 HTTPS
- 用户输入必须进行验证
- 日志中不得包含敏感信息
- 密码必须进行加密存储
- API 必须进行身份认证和授权

## 13. API 设计规范

### 13.1 内部 API 设计

- 使用 RESTful API 设计风格
- API 版本号必须在 URL 中明确指定，如 `/api/v1/download`
- 请求方法：
  - GET：获取资源
  - POST：创建资源
  - PUT：更新资源
  - DELETE：删除资源
- 响应格式：
  ```json
  {
    "code": 200,
    "message": "success",
    "data": {}
  }
  ```
- 错误响应格式：
  ```json
  {
    "code": 400,
    "message": "error message",
    "data": null
  }
  ```

### 13.2 钉钉 API 调用规范

#### 13.2.1 API 版本选择策略

根据钉钉官方文档和产品能力对比，我们**优先选择新版服务端 API**，具体策略如下：

- **优先使用新版 API**：新版服务端 API 包含全部的服务端 API 产品能力，支持 Go 语言 SDK，持续开放新能力
- **旧版 API 兼容**：对于尚未升级到新版规范的 API，临时使用旧版 API，待升级完成后统一迁移到新版 API
- **计划迁移**：随着旧版 API 逐步升级到新版规范，最终全部使用新版 API

#### 13.2.2 旧版与新版 API 对比

| 对比项 | 旧版服务端 API | 新版服务端 API |
|--------|---------------|---------------|
| 规范 | 旧版规范 | 新版规范 |
| SDK 支持 | Java、PHP、Python、.NET、.NET Core | Java（Maven）、Node.js、PHP、Go、C#、Python |
| 开放能力 | 部分开放，不再开放新能力 | 包含全部服务端 API 产品能力，持续开放新能力 |
| 推荐程度 | 已接入应用可继续使用，接口不会下线 | 推荐新接入应用使用 |

#### 13.2.3 API 调用规范

- **严格参考官方文档**：所有钉钉 API 调用必须严格参照钉钉官方开发文档
- **认证方式**：
  - 旧版 API：使用 AppKey、AppSecret 进行认证
  - 新版 API：根据官方文档要求配置相应参数
- **API 版本管理**：
  - 支持同时调用旧版和新版 API
  - 根据钉钉官方文档要求动态调整 API 调用方式
- **参数验证**：所有 API 参数必须严格按照官方文档要求进行验证
- **调用频率控制**：严格遵守官方文档中的调用频率限制
- **错误处理**：根据官方文档中定义的错误码进行错误处理
- **日志记录**：记录所有 API 调用的请求和响应信息
- **SDK 使用**：优先使用官方提供的 Go 语言 SDK，确保与官方 API 保持同步

## 14. 前端开发规范

- 使用 Vue 3 Composition API
- 组件设计遵循单一职责原则
- 使用 Pinia 进行状态管理
- 使用 Vue Router 进行路由管理
- 样式使用 CSS 预处理器（如 SCSS）或 CSS-in-JS
- 响应式设计，支持多种屏幕尺寸

## 15. 后端开发规范

- 采用分层架构：控制器层 → 服务层 → 数据访问层
- 使用 Gin 框架构建 RESTful API
- 中间件使用：CORS、日志、错误处理
- 数据库操作使用 ORM 框架（GORM）
- 事务管理：关键操作必须使用事务

## 16. 数据库规范

### 16.1 数据库设计规范

- **数据库命名**：使用小写字母和下划线组合，如 `dd_oa_download`
- **表命名**：使用小写字母和下划线组合，如 `user`, `role`, `menu`
- **字段命名**：使用小写字母和下划线组合，如 `user_id`, `user_name`
- **主键设计**：使用 `id` 作为主键，类型为 `bigint`，自增
- **外键设计**：使用 `表名_id` 作为外键，如 `role_id`
- **索引设计**：
  - 主键自动创建索引
  - 外键必须创建索引
  - 经常查询的字段必须创建索引
  - 索引名称使用 `idx_表名_字段名` 格式

### 16.2 数据库操作规范

- **使用 ORM 框架**：必须使用 GORM 框架进行数据库操作
- **避免直接 SQL**：尽量避免直接使用 SQL 语句，优先使用 GORM 提供的方法
- **批量操作**：批量插入或更新数据时，使用 `CreateInBatches` 或 `Updates` 方法
- **事务管理**：
  - 关键操作必须使用事务
  - 使用 `db.Transaction()` 方法进行事务管理
  - 事务中必须包含完整的错误处理

### 16.3 数据库连接规范

- **连接池配置**：
  - 最大连接数：根据服务器配置调整，建议 100-200
  - 最大空闲连接数：建议 50-100
  - 连接最大空闲时间：建议 10 分钟
  - 连接最大生命周期：建议 1 小时
- **连接关闭**：使用 `defer db.Close()` 关闭数据库连接
- **错误处理**：必须处理数据库连接错误

### 16.4 数据迁移规范

- 使用 GORM 的 AutoMigrate 功能进行数据迁移
- 迁移文件必须包含版本信息
- 迁移必须可逆，支持回滚
- 迁移前必须备份数据

## 17. Redis 规范

### 17.1 Redis 使用场景

- **缓存**：热点数据缓存、接口响应缓存
- **会话存储**：用户登录会话、Token 存储
- **计数器**：接口调用次数、访问量统计
- **消息队列**：异步任务处理、事件通知
- **分布式锁**：并发控制、资源保护

### 17.2 Redis 连接配置

- **连接池配置**：
  - 最大连接数：根据服务器配置调整，建议 100-200
  - 最大空闲连接数：建议 50-100
  - 连接超时时间：建议 5 秒
  - 读取超时时间：建议 3 秒
  - 写入超时时间：建议 3 秒
- **连接关闭**：使用 `defer client.Close()` 关闭 Redis 连接
- **错误处理**：必须处理 Redis 连接错误

### 17.3 Redis 操作规范

- **使用 Redis 客户端**：必须使用 github.com/go-redis/redis/v8 客户端
- **键命名规范**：使用 `业务模块:功能:标识` 格式，如 `user:session:123`
- **过期时间设置**：所有缓存数据必须设置合理的过期时间
- **批量操作**：批量插入或更新数据时，使用 `Pipeline` 或 `TxPipeline`
- **事务管理**：关键操作必须使用 `TxPipeline` 或 `Watch` 进行事务管理

### 17.4 Redis 数据结构选择

- **字符串（String）**：存储简单值、计数器
- **哈希（Hash）**：存储对象，如用户信息
- **列表（List）**：存储有序数据，如消息队列
- **集合（Set）**：存储无序唯一数据，如标签
- **有序集合（Sorted Set）**：存储有序唯一数据，如排行榜

### 17.5 Redis 持久化配置

- **RDB 持久化**：开启 RDB 持久化，定期保存数据快照
- **AOF 持久化**：开启 AOF 持久化，记录所有写操作
- **混合持久化**：开启混合持久化，结合 RDB 和 AOF 的优点

### 17.6 Redis 集群配置

- 生产环境建议使用 Redis 集群
- 集群节点数量建议为奇数，至少 3 个节点
- 开启集群模式时，使用 `redis.ClusterClient` 替代 `redis.Client`

作者: cjx
邮箱: xx4125517@126.com
时间: 2025-12-20 12:00:00